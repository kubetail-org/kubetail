name: publish-winget

permissions:
  contents: read

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      version:
        description: "Version to deploy"
        required: true
        type: string
      dry_run:
        description: "Dry run"
        required: false
        type: boolean
        default: true

jobs:
  winget-release:
    name: Release on winget
    runs-on: ubuntu-24.04
    steps:
      - name: Configure
        id: config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/cli/v}" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Download SHA256SUMS
        id: release-info
        uses: robinraju/release-downloader@v1.12
        with:
          repository: kubetail-org/kubetail
          tag: ${{ format('cli/v{0}', steps.config.outputs.version) }}
          fileName: "SHA256SUMS"

      - name: Extract shasums
        id: meta
        run: |
          AMD64_SHA256=$( tr -d '\r' < './SHA256SUMS' | awk '$2 == "kubetail-windows-amd64" {print $1}' )
          ARM64_SHA256=$( tr -d '\r' < './SHA256SUMS' | awk '$2 == "kubetail-windows-arm64" {print $1}' )

          echo "amd64_sha256=$AMD64_SHA256" >> $GITHUB_OUTPUT
          echo "arm64_sha256=$ARM64_SHA256" >> $GITHUB_OUTPUT

      - name: Checkout kubetail repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: .github/ci-config/winget
          sparse-checkout-cone-mode: false
          path: kubetail

      - name: Checkout winget-pkgs repo
        uses: actions/checkout@v4
        with:
          repository: microsoft/winget-pkgs
          fetch-depth: 1
          sparse-checkout: manifests/k/Kubetail/Kubetail
          sparse-checkout-cone-mode: false
          path: winget-pkgs

      - name: Execute winget manifest templates
        env:
          VERSION: ${{ steps.config.outputs.version }}
          AMD64_SHA256: ${{ steps.meta.outputs.amd64_sha256 }}
          ARM64_SHA256: ${{ steps.meta.outputs.arm64_sha256 }}
          SRC_DIR: kubetail/.github/ci-config/winget
          DST_DIR: winget-pkgs/manifests/k/Kubetail/Kubetail/${{ steps.config.outputs.version }}
        run: |
          set -euo pipefail

          mkdir -p "${DST_DIR}"

          # Kubetail.Kubetail.yaml
          envsubst '${VERSION}' \
            < "${SRC_DIR}/Kubetail.Kubetail.yaml.tmpl" \
            > "${DST_DIR}/Kubetail.Kubetail.yaml"

          # Kubetail.Kubetail.locale.en-US.yaml
          envsubst '${VERSION}' \
            < "${SRC_DIR}/Kubetail.Kubetail.locale.en-US.yaml.tmpl" \
            > "${DST_DIR}/Kubetail.Kubetail.locale.en-US.yaml"

          # Kubetail.Kubetail.installer.yaml
          envsubst '${VERSION} ${AMD64_SHA256} ${ARM64_SHA256}' \
            < "${SRC_DIR}/Kubetail.Kubetail.installer.yaml.tmpl" \
            > "${DST_DIR}/Kubetail.Kubetail.installer.yaml"

          if [ "${{ steps.config.outputs.dry_run }}" == "true" ]; then
            ls -lah "${DST_DIR}"
            cat "${DST_DIR}"/*
          fi

      - name: Commit and raise PR from forked repo
        uses: peter-evans/create-pull-request@v7.0.8
        if: ${{ steps.config.outputs.dry_run != 'true' }}
        with:
          token: ${{ secrets.PUBLISH_WINGET_TOKEN }}
          path: ./winget-pkgs
          commit-message: "New version: Kubetail.Kubetail ${{ steps.config.outputs.version }}"
          title: "New version: Kubetail.Kubetail version ${{ steps.config.outputs.version }}"
          body: "This PR adds the manifest for Kubetail.Kubetail version ${{ steps.config.outputs.version }}."
          branch: winget-release-kubetail-${{ steps.config.outputs.version }}
          base: master
          push-to-fork: kubetail-org/winget-pkgs
