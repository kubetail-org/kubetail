name: publish-macports

permissions:
  contents: read
  deployments: write

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      version:
        description: "Version to deploy"
        required: true
        type: string
      port_checks:
        description: "Run port checks"
        required: true
        type: boolean
        default: true
      dry_run:
        description: "Dry run"
        required: false
        type: boolean
        default: true

jobs:
  publish:
    name: Publish
    environment: production
    runs-on: macos-26
    timeout-minutes: 20
    env:
      UPSTREAM_REPO: macports/macports-ports
      FORK_REPO: kubetail-org/macports-ports
    steps:
      - name: Config
        id: config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "port_checks=${{ github.event.inputs.port_checks }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/cli/v}" >> $GITHUB_OUTPUT
            echo "port_checks=false" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout macports-ports upstream repo
        uses: actions/checkout@v4
        with:
          repository: "${{ env.UPSTREAM_REPO }}"
          sparse-checkout: devel/kubetail
          sparse-checkout-cone-mode: false
          path: macports-ports
          persist-credentials: false

      - name: Move macports-ports to /private/tmp
        id: temp
        run: |
          mv macports-ports /private/tmp
          echo "dir=/private/tmp" >> $GITHUB_OUTPUT

      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/ci-config/macports
          sparse-checkout-cone-mode: false
          path: kubetail
          persist-credentials: false

      - name: Download vendored source bundle
        uses: robinraju/release-downloader@v1.12
        with:
          repository: kubetail-org/kubetail
          tag: ${{ format('cli/v{0}', steps.config.outputs.version) }}
          fileName: kubetail-${{ steps.config.outputs.version }}-vendored.tar.gz
          out-file-path: "downloads"

      - name: Extract metadata
        id: meta
        working-directory: ./downloads
        env:
          ARCHIVE_NAME: kubetail-${{ steps.config.outputs.version }}-vendored.tar.gz
        run: |
          SIZE=$(stat -f '%z' "$ARCHIVE_NAME")
          RMD160=$(openssl dgst -rmd160 "$ARCHIVE_NAME" | awk '{print $NF}')
          SHA256=$(shasum -a 256 "$ARCHIVE_NAME" | awk '{print $1}')

          echo "size=$SIZE" >> "$GITHUB_OUTPUT"
          echo "rmd160=$RMD160" >> "$GITHUB_OUTPUT"
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"

      - name: Execute Portfile template
        env:
          VERSION: ${{ steps.config.outputs.version }}
          RMD160: ${{ steps.meta.outputs.rmd160 }}
          SHA256: ${{ steps.meta.outputs.sha256 }}
          SIZE: ${{ steps.meta.outputs.size }}
          SRC_DIR: kubetail/.github/ci-config/macports
          DST_DIR: "${{ steps.temp.outputs.dir }}/macports-ports/devel/kubetail"
        run: |
          envsubst '${VERSION} ${RMD160} ${SHA256} ${SIZE}' \
            < "${SRC_DIR}/Portfile.tmpl" \
            > "${DST_DIR}/Portfile"

          if [ "${{ steps.config.outputs.dry_run }}" == "true" ]; then
            cat "${DST_DIR}/Portfile"
          fi

      - name: Install macports
        if: ${{ steps.config.outputs.port_checks == 'true' }}
        run: |
          curl -fL -o MacPorts.pkg https://github.com/macports/macports-base/releases/download/v2.11.6/MacPorts-2.11.6-26-Tahoe.pkg
          printf 'Agree\n' | sudo installer -pkg MacPorts.pkg -target /
          echo "PATH=/opt/local/bin:/opt/local/sbin:$PATH" >> "$GITHUB_ENV"

      - name: "Port Check: Lint"
        if: ${{ steps.config.outputs.port_checks == 'true' }}
        working-directory: "${{ steps.temp.outputs.dir }}/macports-ports/devel/kubetail"
        run: |
          lint_output="$(port lint kubetail 2>&1)"
          lint_status=$?
          printf '%s\n' "$lint_output"
          if [ "$lint_status" -ne 0 ]; then
            exit "$lint_status"
          fi
          if ! printf '%s\n' "$lint_output" | grep -Fq "0 errors and 0 warnings found"; then
            echo "::error::port lint did not report \"0 errors and 0 warnings found\"."
            exit 1
          fi

      - name: "Port Check: Test"
        if: ${{ steps.config.outputs.port_checks == 'true' }}
        working-directory: "${{ steps.temp.outputs.dir }}/macports-ports/devel/kubetail"
        run: |
          sudo port test -N

      - name: "Port Check: Install"
        if: ${{ steps.config.outputs.port_checks == 'true' }}
        working-directory: "${{ steps.temp.outputs.dir }}/macports-ports/devel/kubetail"
        run: |
          sudo port install -N

      - name: "Port Check: Test binary"
        if: ${{ steps.config.outputs.port_checks == 'true' }}
        run: |
          expected="kubetail version ${{ steps.config.outputs.version }}"
          actual="$(kubetail --version)"
          echo "$actual"
          if [ "$actual" != "$expected" ]; then
            echo "::error::expected \"$expected\" but got \"$actual\""
            exit 1
          fi

      - name: Execute PR body template
        id: pr_body
        env:
          VERSION: ${{ steps.config.outputs.version }}
          SRC_DIR: kubetail/.github/ci-config/macports
        run: |
          FILE="$(mktemp)"

          export TESTED_ON_STRING="$(sh -c 'echo "macOS $(sw_vers -productVersion) $(sw_vers -buildVersion) $(uname -m)"; xcode=$(xcodebuild -version 2>/dev/null); if [ $? == 0 ]; then echo "$(echo "$xcode" | awk '\''NR==1{x=$0}END{print x" "$NF}'\'')"; else echo "Command Line Tools $(pkgutil --pkg-info=com.apple.pkg.CLTools_Executables | awk '\''/version:/ {print $2}'\'')"; fi')"

          envsubst '${VERSION} ${TESTED_ON_STRING}' \
            < "${SRC_DIR}/pr-body.tmpl" \
            > "$FILE"

          echo "file=$FILE" >> "$GITHUB_OUTPUT"

      - name: Load kubetail-bot ssh key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.KUBETAIL_BOT_SSH_PRIVATE_KEY }}

      - name: Configure gpg
        uses: crazy-max/ghaction-import-gpg@v6.3.0
        with:
          gpg_private_key: ${{ secrets.KUBETAIL_BOT_PGP_SIGNING_KEY }}
          passphrase: ${{ secrets.KUBETAIL_BOT_PGP_PASSWORD }}

      - name: Configure git
        working-directory: "${{ steps.temp.outputs.dir }}/macports-ports/devel/kubetail"
        run: |
          # Configure git
          git config --local gpg.program gpg
          git config --local commit.gpgsign true

          git config --local user.name "${{ vars.KUBETAIL_BOT_NAME }}"
          git config --local user.email "${{ vars.KUBETAIL_BOT_EMAIL }}"
          git config --local user.signingkey "${{ vars.KUBETAIL_BOT_PGP_FINGERPRINT }}"

      - name: Commit changes and raise PR
        working-directory: "${{ steps.temp.outputs.dir }}/macports-ports"
        env:
          GH_TOKEN: ${{ secrets.AMOREY_PAT }}
        run: |
          BRANCH_NAME="release-kubetail-${{ steps.config.outputs.version }}"

          FORK_REPO="${{ env.FORK_REPO }}"
          FORK_REPO_OWNER=${FORK_REPO%%/*}

          # Add fork
          git remote add fork "git@github.com:${{ env.FORK_REPO }}.git"

          # Exit if branch already exists
          if git ls-remote --exit-code --heads fork "${BRANCH_NAME}" >/dev/null 2>&1; then
            echo "remote branch ${BRANCH_NAME} already exists"
            exit 1
          fi

          # Create new branch
          git switch -C "${BRANCH_NAME}"

          # Stage release updates
          git add ./devel/kubetail/Portfile

          # Exit if there are no changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit
          git commit -s -m "kubetail: upgrade to ${{ steps.config.outputs.version }}"

          # Exit if dry_run
          if [ "${{ steps.config.outputs.dry_run }}" == "true" ]; then
            cat devel/kubetail/Portfile
            cat "${{ steps.pr_body.outputs.file }}"
            exit 0
          fi

          # Push to fork
          git push --set-upstream fork "${BRANCH_NAME}"

          # Raise PR
          gh pr create \
            --repo "${{ env.UPSTREAM_REPO }}" \
            --head "${FORK_REPO_OWNER}:${BRANCH_NAME}" \
            --base master \
            --title "kubetail: update to ${{ steps.config.outputs.version }}" \
            --body-file "${{ steps.pr_body.outputs.file }}"
