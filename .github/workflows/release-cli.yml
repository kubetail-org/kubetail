name: release-cli

permissions:
  contents: write
  deployments: write

on:
  push:
    tags:
      - "cli/v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release"
        required: true
        type: string
      signing_policy:
        description: "SignPath slug"
        required: true
        type: choice
        default: test-signing
        options:
          - test-signing
          - release-signing
      dry_run:
        description: "Dry run"
        required: false
        type: boolean
        default: true

jobs:
  config:
    name: Configure workflow
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.config.outputs.version }}
      signing_policy: ${{ steps.config.outputs.signing_policy }}
      dry_run: ${{ steps.config.outputs.dry_run }}
    steps:
      - id: config
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "signing_policy=${{ github.event.inputs.signing_policy }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/cli/v}" >> $GITHUB_OUTPUT
            echo "signing_policy=release-signing" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

  prepare:
    name: Prepare source
    needs: config
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
        with:
          ref: refs/tags/cli/v${{ needs.config.outputs.version }}

      - uses: ./.github/actions/setup-environment
        with:
          setup-node: "true"
          setup-go: "true"

      - name: Build frontend
        working-directory: dashboard-ui
        run: |
          pnpm install
          pnpm build

      - name: Vendor backend
        env:
          GOWORK: off
        run: |
          rm -rf modules/dashboard/website
          mv dashboard-ui/dist modules/dashboard/website
          cd modules/cli
          go mod vendor

      - name: Clean up source directory
        run: |
          rm -rf .git
          rm -rf dashboard-ui/node_modules

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: source
          path: .
          include-hidden-files: true

  build:
    name: Build binaries
    needs: [config, prepare]
    strategy:
      matrix:
        os:
          - darwin
          - linux
          - windows
        arch:
          - amd64
          - arm64
        include:
          - os: darwin
            arch: amd64
            runner: macos-15-intel
          - os: darwin
            arch: arm64
            runner: macos-26
          - os: linux
            arch: amd64
            runner: ubuntu-24.04
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
          - os: windows
            arch: amd64
            runner: windows-2025
          - os: windows
            arch: arm64
            runner: windows-11-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: refs/tags/cli/v${{ needs.config.outputs.version }}
          sparse-checkout: .github/actions/setup-environment
          sparse-checkout-cone-mode: false
          path: repo

      - uses: ./repo/.github/actions/setup-environment
        with:
          setup-go: "true"

      - name: Download source
        uses: actions/download-artifact@v6
        with:
          name: source
          path: kubetail-cli

      - name: Build binary
        working-directory: kubetail-cli/modules/cli
        env:
          GOWORK: off
          CGO_ENABLED: 0
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          LDFLAGS: "-s -w -X 'github.com/kubetail-org/kubetail/modules/cli/cmd.version=${{ needs.config.outputs.version }}'"
        shell: bash
        run: |
          go build -mod=vendor -ldflags="${LDFLAGS}" -o ../../bin/kubetail .

      - name: Append os/arch to binary file name
        working-directory: kubetail-cli
        run: mv bin/kubetail bin/kubetail-${{ matrix.os }}-${{ matrix.arch }}

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          path: kubetail-cli/bin/*
          name: assets-${{ matrix.os }}-${{ matrix.arch }}

  sign-darwin:
    name: Sign darwin binaries
    needs: [config, build]
    environment: production
    runs-on: macos-latest
    strategy:
      matrix:
        arch:
          - amd64
          - arm64
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v6
        with:
          name: assets-darwin-${{ matrix.arch }}
          path: assets

      - name: Import certificate
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_DEVELOPER_CERT_P12_B64 }}
          p12-password: ${{ secrets.APPLE_DEVELOPER_CERT_P12_PASSWORD }}

      - name: Sign and notarize
        env:
          BIN_NAME: kubetail-darwin-${{ matrix.arch }}
        run: |
          BIN_PATH="assets/${BIN_NAME}"

          # Sign compiled binary
          codesign --force --options runtime --timestamp \
            --sign "${{ vars.APPLE_DEVELOPER_CERT_IDENTITY }}" "${BIN_PATH}"

          # Verify signature
          codesign -dv --verbose "${BIN_PATH}"

          # Create archive for notarization
          ditto -c -k --keepParent "${BIN_PATH}" kubetail.zip

          # Create ASC key file
          ASC_KEY_FILE="$(mktemp -t asc-key.XXXXXX.p8)"
          printf '%s' "${{ secrets.APPLE_STORE_CONNECT_KEY_P8 }}" > "$ASC_KEY_FILE"

          # Notarize using ASC secrets
          xcrun notarytool submit kubetail.zip \
            --key "${ASC_KEY_FILE}" \
            --key-id "${{ vars.APPLE_STORE_CONNECT_KEY_ID }}" \
            --issuer "${{ vars.APPLE_STORE_CONNECT_ISSUER_ID }}" \
            --wait

          # Delete keyfile
          rm -f "${ASC_KEY_FILE}"

      - name: Upload signed artifact
        uses: actions/upload-artifact@v5
        with:
          path: assets
          name: assets-darwin-${{ matrix.arch }}
          overwrite: true

  sign-windows:
    name: Create windows zip and sign binaries
    needs: [config, build]
    environment: production
    runs-on: windows-latest
    strategy:
      matrix:
        arch:
          - amd64
          - arm64
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          name: assets-windows-${{ matrix.arch }}
          path: assets

      - name: Create zip archive
        working-directory: ./assets
        shell: pwsh
        run: |
          $file = "kubetail-windows-${{ matrix.arch }}"
          Copy-Item -Path $file -Destination kubetail.exe
          Compress-Archive -Path kubetail.exe -DestinationPath "${file}.zip"
          Remove-Item kubetail.exe

      - id: upload-artifact
        name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          path: assets
          name: assets-windows-${{ matrix.arch }}
          overwrite: true

      - name: Sign Windows Binaries
        uses: signpath/github-action-submit-signing-request@v1.1
        with:
          api-token: "${{ secrets.SIGNPATH_API_TOKEN }}"
          organization-id: "${{ vars.SIGNPATH_ORGANIZATION_ID }}"
          project-slug: "kubetail"
          signing-policy-slug: "${{ needs.config.outputs.signing_policy }}"
          github-artifact-id: "${{ steps.upload-artifact.outputs.artifact-id }}"
          wait-for-completion: true
          output-artifact-directory: assets
          parameters: |
            os: ${{ toJSON('windows') }}
            arch: ${{ toJSON(matrix.arch) }}
            version: ${{ toJSON(needs.config.outputs.version) }}

      - name: Upload signed artifacts
        uses: actions/upload-artifact@v5
        with:
          path: assets
          name: assets-windows-${{ matrix.arch }}
          overwrite: true

  package-tarball:
    name: Create gzipped tarballs
    needs: [config, sign-darwin, sign-windows]
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        os:
          - darwin
          - linux
          - windows
        arch:
          - amd64
          - arm64
    steps:
      - uses: actions/checkout@v5
        with:
          ref: refs/tags/cli/v${{ needs.config.outputs.version }}
          sparse-checkout: |
            LICENSE
          sparse-checkout-cone-mode: false
          path: repo

      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          name: assets-${{ matrix.os }}-${{ matrix.arch }}
          path: assets

      - name: Create gzipped tarball
        env:
          REPO_DIR: repo
          ASSETS_DIR: assets
          OUTPUT_DIR: out
          BIN_NAME: kubetail-${{ matrix.os }}-${{ matrix.arch }}
        run: |
          mkdir -p "${OUTPUT_DIR}"
          TEMP_DIR="$(mktemp -d)"

          TARGET_NAME="kubetail"
          if [ "${{ matrix.os }}" = "windows" ]; then
            TARGET_NAME="kubetail.exe"
          fi

          chmod +x "${ASSETS_DIR}/${BIN_NAME}"
          mv "${ASSETS_DIR}/${BIN_NAME}" "${TEMP_DIR}/${TARGET_NAME}"
          cp "${REPO_DIR}/LICENSE" "${TEMP_DIR}/LICENSE"
          tar -C "${TEMP_DIR}" -czf "${OUTPUT_DIR}/${BIN_NAME}.tar.gz" "${TARGET_NAME}" LICENSE
          rm -rf "${TEMP_DIR}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: assets-${{ matrix.os }}-${{ matrix.arch }}-tgz
          path: out

  release:
    name: Create GitHub release
    needs: [config, package-tarball]
    environment: production
    runs-on: ubuntu-24.04
    steps:
      - name: Download binaries
        uses: actions/download-artifact@v6
        with:
          pattern: assets-*
          path: assets
          merge-multiple: true

      - name: Download vendored source
        uses: actions/download-artifact@v6
        with:
          name: source
          path: kubetail-${{ needs.config.outputs.version }}

      - name: Create vendored tarball
        env:
          VERSION: ${{ needs.config.outputs.version }}
        run: |
          tar -czf "assets/kubetail-${VERSION}-vendored.tar.gz" "kubetail-${VERSION}"

      - name: Generate SHA-256 checksums
        working-directory: ./assets
        run: |
          sha256sum * > SHA256SUMS

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6.3.0
        with:
          gpg_private_key: ${{ secrets.KUBETAIL_BOT_GPG_SIGNING_KEY }}
          passphrase: ${{ secrets.KUBETAIL_BOT_GPG_PASSWORD }}
          fingerprint: ${{ vars.KUBETAIL_BOT_GPG_SIGNING_KEY_FINGERPRINT }}

      - name: Sign SHA256SUMS with GPG
        working-directory: ./assets
        run: |
          gpg --armor --detach-sign SHA256SUMS

      - name: Debug
        if: ${{ needs.config.outputs.dry_run == 'true' }}
        run: |
          ls -lah assets/*
          cat assets/SHA256SUMS
          cat assets/SHA256SUMS.asc

      - name: Create release
        uses: softprops/action-gh-release@v2.3.2
        if: ${{ needs.config.outputs.dry_run == 'false' }}
        with:
          files: assets/*
          draft: true

      - name: Cleanup GPG
        if: always()
        run: rm -rf ~/.gnupg
