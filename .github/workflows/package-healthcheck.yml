name: package-healthcheck

on:
  schedule:
    - cron: "23 3 * * *" # daily, UTC
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: package-healthcheck
  cancel-in-progress: true

jobs:
  linux:
    if: github.repository == 'kubetail-org/kubetail'
    strategy:
      fail-fast: false
      matrix:
        mgr:
          - arch-aur
          - asdf
          - gentoo-guru
          - homebrew
          - krew
          - nix
        arch:
          - amd64
          - arm64
        include:
          # --- for arches ---
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
          # --- for package managers ---
          - mgr: arch-aur
            image: archlinux:latest
            os: arch
            setup: |
              pacman -Syu --noconfirm
              pacman -S --noconfirm base-devel git

              useradd -m builder
              passwd -d builder
              echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
            install: |
              su - builder -c 'git clone https://aur.archlinux.org/kubetail-cli.git && cd kubetail-cli && makepkg -si --noconfirm'
            version: |
              kubetail --version
          - mgr: asdf
            image: homebrew/brew:latest
            os: linux
            setup: |
              brew install asdf
            install: |
              asdf plugin add kubetail https://github.com/kubetail-org/asdf-kubetail.git
              asdf install kubetail latest
            version: |
              asdf latest kubetail
          - mgr: gentoo-guru
            image: gentoo/stage3:latest
            os: gentoo
            setup: |
              emaint sync -a > /dev/null
              emerge app-eselect/eselect-repository > /dev/null
              eselect repository enable guru
              emaint sync -r guru > /dev/null
            install: |
              ACCEPT_KEYWORDS="~$(portageq envvar ARCH)" emerge dev-util/kubetail
            version: |
              kubetail --version
          - mgr: homebrew
            image: homebrew/brew:latest
            os: linux
            setup: skip
            install: |
              brew install kubetail
            version: |
              kubetail --version
          - mgr: krew
            image: bitnami/kubectl:latest
            os: linux
            setup: |
              apt-get update && apt-get install -y curl tar git
              set -eux
              curl -fsSLO https://github.com/kubernetes-sigs/krew/releases/latest/download/krew-linux_${ARCH}.tar.gz
              tar zxvf krew-linux_${ARCH}.tar.gz
              ./krew-linux_${ARCH} install krew
              echo "$HOME/.krew/bin" >> $GITHUB_PATH
            install: |
              PATH="$HOME/.krew/bin:$PATH" kubectl krew install kubetail
            version: |
              kubectl kubetail --version
          - mgr: nix
            image: ubuntu:24.04
            os: ubuntu-24.04
            setup: |
              apt-get update && apt-get install -y curl
              curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --no-confirm --init none
            install: |
              . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
              nix-env -i -f https://github.com/kubetail-org/kubetail-nix/archive/refs/heads/main.tar.gz
            version: |
              . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
              kubetail --version
        exclude:
          - mgr: arch-aur
            arch: arm64
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.image }}
      options: --user 0 --platform linux/${{ matrix.arch }}
    env:
      ARCH: ${{ matrix.arch }}
      TRIPLET: ${{ matrix.mgr }}_${{ matrix.os }}_${{ matrix.arch }}
    steps:
      - &setup_step
        name: Setup
        shell: bash
        run: |
          set -euxo pipefail
          # Run matrix setup script via heredoc to avoid premature $ expansion under set -u
          if [ "${{ matrix.setup }}" != "skip" ]; then
            eval "${{ matrix.setup }}"
          fi

      - &install_step
        name: Install
        shell: bash
        run: |
          set -euxo pipefail
          eval "${{ matrix.install }}"

      - &version_step
        name: Check version
        shell: bash
        run: |
          set -euxo pipefail
          cli_ver="$(eval "${{ matrix.version }}")"

          # Save result for summary table
          mkdir -p /tmp/results
          echo "${cli_ver}" > "/tmp/results/${{ env.TRIPLET }}.txt"

      - &upload_step
        name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: version-${{ env.TRIPLET }}
          path: /tmp/results/*.txt
          retention-days: 1

  linux-apt:
    if: github.repository == 'kubetail-org/kubetail'
    strategy:
      fail-fast: false
      matrix:
        series:
          - jammy
          - noble
          - plucky
        arch:
          - amd64
          - arm64
        include:
          # --- for arches ---
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
          # --- for series ---
          - series: jammy
            image: ubuntu:22.04
          - series: noble
            image: ubuntu:24.04
          - series: plucky
            image: ubuntu:25.04
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.image }}
      options: --user 0 --platform linux/${{ matrix.arch }}
    env:
      TRIPLET: apt_${{ matrix.series }}_${{ matrix.arch }}
    steps:
      - name: Setup
        shell: bash
        run: |
          apt-get update
          apt-get install -y software-properties-common curl jq

      - name: Install
        shell: bash
        run: |
          add-apt-repository -y ppa:kubetail/kubetail
          apt-get update
          apt-get install -y kubetail-cli

      - name: Check version
        shell: bash
        run: |
          set -euxo pipefail
          cli_ver="$(kubetail --version)"

          # Save result for summary table
          mkdir -p /tmp/results
          echo "${cli_ver}" > "/tmp/results/${{ env.TRIPLET }}.txt"

      - *upload_step

  linux-copr:
    if: github.repository == 'kubetail-org/kubetail'
    strategy:
      fail-fast: false
      matrix:
        os:
          - centos-stream-9
          - centos-stream-10
          - fedora-41
          - fedora-42
          - fedora-43
          - fedora-rawhide
          - mageia-9
          - rhel-8
          - rhel-9
          - rhel-10
        arch:
          - amd64
          - arm64
        include:
          # --- for arches ---
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
          # --- for oses ---
          - os: centos-stream-9
            image: dokken/centos-stream-9:latest
          - os: centos-stream-10
            image: dokken/centos-stream-10:latest
          - os: fedora-41
            image: fedora:41
          - os: fedora-42
            image: fedora:42
          - os: fedora-43
            image: fedora:43
          - os: fedora-rawhide
            image: fedora:rawhide
          - os: mageia-9
            image: mageia:9
          - os: rhel-8
            image: redhat/ubi8:latest
          - os: rhel-9
            image: redhat/ubi9:latest
          - os: rhel-10
            image: redhat/ubi10:latest
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.image }}
      options: --user 0 --platform linux/${{ matrix.arch }}
    env:
      TRIPLET: copr_${{ matrix.os }}_${{ matrix.arch }}
    steps:
      - name: Setup
        run: |
          dnf -y install dnf-plugins-core

      - name: Install
        run: |
          dnf -y copr enable kubetail/kubetail
          dnf -y install kubetail

      - name: Check version
        shell: bash
        run: |
          set -euxo pipefail
          cli_ver="$(kubetail --version)"

          # Save result for summary table
          mkdir -p /tmp/results
          echo "${cli_ver}" > "/tmp/results/${{ env.TRIPLET }}.txt"

      - *upload_step

  linux-dnf:
    if: github.repository == 'kubetail-org/kubetail'
    strategy:
      fail-fast: false
      matrix:
        os:
          - fedora-43
          - fedora-42
          - fedora-41
          - fedora-rawhide
          - centos-stream-10
          - centos-stream-9
          - rhel-8
        arch:
          - amd64
          - arm64
        include:
          # --- for arches ---
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
          # --- for oses ---
          - os: fedora-43
            image: fedora:43
            distro: Fedora_43
            setup: |
              dnf config-manager addrepo --from-repofile=https://download.opensuse.org/repositories/home:/kubetail/${DISTRO}/home:kubetail.repo
          - os: fedora-42
            image: fedora:42
            distro: Fedora_42
            setup: |
              dnf config-manager addrepo --from-repofile=https://download.opensuse.org/repositories/home:/kubetail/${DISTRO}/home:kubetail.repo
          - os: fedora-41
            image: fedora:41
            distro: Fedora_41
            setup: |
              dnf config-manager addrepo --from-repofile=https://download.opensuse.org/repositories/home:/kubetail/${DISTRO}/home:kubetail.repo
          - os: fedora-rawhide
            image: fedora:rawhide
            distro: Fedora_Rawhide
            setup: |
              dnf config-manager addrepo --from-repofile=https://download.opensuse.org/repositories/home:/kubetail/${DISTRO}/home:kubetail.repo
          - os: centos-stream-10
            image: dokken/centos-stream-10:latest
            distro: CentOS_Stream_10
            setup: |
              dnf config-manager addrepo --add-repo https://download.opensuse.org/repositories/home:/kubetail/${DISTRO}/home:kubetail.repo
          - os: centos-stream-9
            image: dokken/centos-stream-9:latest
            distro: CentOS_Stream_9
            setup: |
              dnf config-manager addrepo --add-repo https://download.opensuse.org/repositories/home:/kubetail/${DISTRO}/home:kubetail.repo
          - os: rhel-8
            image: redhat/ubi8:latest
            distro: RHEL_8
            setup: |
              dnf config-manager addrepo --add-repo https://download.opensuse.org/repositories/home:/kubetail/${DISTRO}/home:kubetail.repo
        exclude:
          - os: rhel-8
            arch: arm64
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.image }}
      options: --user 0 --platform linux/${{ matrix.arch }}
    env:
      DISTRO: ${{ matrix.distro }}
      TRIPLET: dnf_${{ matrix.os }}_${{ matrix.arch }}
    steps:
      - *setup_step

      - name: Install
        shell: bash
        run: |
          set -euxo pipefail
          dnf -y install kubetail-cli

      - name: Check version
        shell: bash
        run: |
          set -euxo pipefail
          cli_ver="$(kubetail --version)"

          # Save result for summary table
          mkdir -p /tmp/results
          echo "${cli_ver}" > "/tmp/results/${{ env.TRIPLET }}.txt"

      - *upload_step

  linux-snap:
    if: github.repository == 'kubetail-org/kubetail'
    strategy:
      fail-fast: false
      matrix:
        arch:
          - amd64
          - arm64
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    env:
      TRIPLET: snap_ubuntu-24.04_${{ matrix.arch }}
    steps:
      - name: Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y snapd
          sudo systemctl enable --now snapd
          sudo systemctl status snapd --no-pager

      - name: Install
        run: |
          sudo snap install kubetail

      - name: Check version
        run: |
          set -euxo pipefail
          cli_ver="$(kubetail --version)"

          # Save result for summary table
          mkdir -p /tmp/results
          echo "${cli_ver}" > "/tmp/results/${{ env.TRIPLET }}.txt"

      - *upload_step

  linux-zypper:
    if: github.repository == 'kubetail-org/kubetail'
    strategy:
      fail-fast: false
      matrix:
        os:
          - opensuse-leap-16.0
          - opensuse-leap-15.6
          - opensuse-leap-15.5
        arch:
          - amd64
          - arm64
        include:
          # --- for arches ---
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
          # --- for oses ---
          - os: opensuse-leap-16.0
            image: opensuse/leap:16.0
          - os: opensuse-leap-15.6
            image: opensuse/leap:15.6
          - os: opensuse-leap-15.5
            image: opensuse/leap:15.5
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.image }}
      options: --user 0 --platform linux/${{ matrix.arch }}
    env:
      TRIPLET: zypper_${{ matrix.os }}_${{ matrix.arch }}
    steps:
      - name: Install
        shell: bash
        run: |
          set -euxo pipefail
          zypper -n refresh
          rpm --import https://download.opensuse.org/repositories/home:/kubetail/15.6/repodata/repomd.xml.key
          zypper -n addrepo "https://download.opensuse.org/repositories/home:/kubetail/15.6/" kubetail
          zypper -n refresh
          zypper install -y kubetail-cli

      - name: Check version
        shell: bash
        run: |
          set -euxo pipefail
          cli_ver="$(kubetail --version)"

          # Save result for summary table
          mkdir -p /tmp/results
          echo "${cli_ver}" > "/tmp/results/${{ env.TRIPLET }}.txt"

      - *upload_step

  macos:
    if: github.repository == 'kubetail-org/kubetail'
    strategy:
      fail-fast: false
      matrix:
        mgr:
          - asdf
          - homebrew
          - krew
          - macports
          - nix
        os:
          - macos-26
          - macos-15
        arch:
          - amd64
          - arm64
        include:
          # --- for os/arch ---
          - os: macos-26
            arch: arm64
            runner: macos-26
            macports_url: https://github.com/macports/macports-base/releases/download/v2.11.6/MacPorts-2.11.6-26-Tahoe.pkg
          - os: macos-15
            arch: amd64
            runner: macos-15-intel
            macports_url: https://github.com/macports/macports-base/releases/download/v2.10.5/MacPorts-2.10.5-15-Sequoia.pkg
          - os: macos-15
            arch: arm64
            runner: macos-15
            macports_url: https://github.com/macports/macports-base/releases/download/v2.10.5/MacPorts-2.10.5-15-Sequoia.pkg
          # --- for package managers ---
          - mgr: asdf
            setup: |
              brew install asdf
            install: |
              asdf plugin add kubetail https://github.com/kubetail-org/asdf-kubetail.git
              asdf install kubetail latest
            version: |
              asdf latest kubetail
          - mgr: homebrew
            setup: skip
            install: |
              brew update
              brew install kubetail
            version: |
              kubetail --version
          - mgr: krew
            setup: |
              brew install kubectl
              curl -fsSLO https://github.com/kubernetes-sigs/krew/releases/latest/download/krew-darwin_${ARCH}.tar.gz
              tar zxvf krew-darwin_${ARCH}.tar.gz
              ./krew-darwin_${ARCH} install krew
              echo "$HOME/.krew/bin" >> $GITHUB_PATH
            install: |
              kubectl krew update
              kubectl krew install kubetail
            version: |
              kubectl kubetail --version
          - mgr: macports
            setup: |
              # Set MacPorts installer URL based on OS version
              curl -fL -o MacPorts.pkg "${MACPORTS_URL}"
              printf 'Agree\n' | sudo installer -pkg MacPorts.pkg -target /
              echo "PATH=/opt/local/bin:/opt/local/sbin:$PATH" >> "$GITHUB_ENV"
            install: |
              sudo /opt/local/bin/port -v selfupdate
              sudo /opt/local/bin/port install kubetail
            version: |
              kubetail --version
          - mgr: nix
            setup: |
              curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
            install: |
              . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
              nix-env -i -f https://github.com/kubetail-org/kubetail-nix/archive/refs/heads/main.tar.gz
            version: |
              . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
              kubetail --version
        exclude:
          - os: macos-26
            arch: amd64
          - mgr: nix
            arch: amd64
    runs-on: ${{ matrix.runner }}
    env:
      ARCH: ${{ matrix.arch }}
      TRIPLET: ${{ matrix.mgr }}_${{ matrix.os }}_${{ matrix.arch }}
      MACPORTS_URL: ${{ matrix.macports_url }}
    steps:
      - *setup_step

      - *install_step

      - *version_step

      - *upload_step

  windows:
    if: github.repository == 'kubetail-org/kubetail'
    strategy:
      fail-fast: false
      matrix:
        mgr:
          - winget
          - chocolatey
          - scoop
        arch:
          - arm64
          - amd64
        include:
          # --- for arches ---
          - arch: amd64
            runner: windows-2025
          - arch: arm64
            runner: windows-11-arm
          # --- for package managers ---
          - mgr: winget
            install: |
              winget install -e kubetail --accept-source-agreements --accept-package-agreements
            check_ver: |
              $env:PATH = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

              # Add common winget install locations to PATH
              $wingetPaths = @(
                "$env:LOCALAPPDATA\Microsoft\WinGet\Links",
                "$env:LOCALAPPDATA\Microsoft\WinGet\Packages"
              )
              foreach ($path in $wingetPaths) {
                if (Test-Path $path) {
                  $env:PATH = "$path;" + $env:PATH
                }
              }

              kubetail.exe --version
          - mgr: chocolatey
            setup: |
              # Add chocolatey bin to PATH
              if ($env:ChocolateyInstall) {
                $chocoBin = "$($env:ChocolateyInstall)\bin"
                if ($chocoBin) {
                  $env:PATH = "$chocoBin;" + $env:PATH
                  $chocoBin | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                }
              }
            install: |
              choco install kubetail -y --no-progress
            check_ver: |
              kubetail.exe --version
          - mgr: scoop
            setup: |
              # Install scoop if not present
              if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
                iwr -useb get.scoop.sh | iex
              }
              if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
                throw "scoop install failed"
              }

              # Add scoop shims to PATH for subsequent steps
              $scoopShims = "$env:USERPROFILE\scoop\shims"
              if (Test-Path $scoopShims) {
                $env:PATH = "$scoopShims;" + $env:PATH
                $scoopShims | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
              }

              # Add extras bucket
              try { scoop bucket add extras | Out-Null } catch { }
            install: |
              scoop install kubetail
            check_ver: |
              kubetail.exe --version
        exclude:
          - mgr: winget
            arch: arm64
    runs-on: ${{ matrix.runner }}
    env:
      TRIPLET: ${{ matrix.mgr }}_windows_${{ matrix.arch }}
    steps:
      - name: Setup
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'

          $setup = @'
          ${{ matrix.setup }}
          '@.Trim()
          if ($setup) {
            Invoke-Expression $setup
          }

      - name: Install
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'

          $install = @'
          ${{ matrix.install }}
          '@.Trim()
          if ($install) {
            Invoke-Expression $install
          }

      - name: Check version
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'

          $check = @'
          ${{ matrix.check_ver }}
          '@.Trim()
          $out = Invoke-Expression $check 2>&1
          $ver = ($out | Select-String -Pattern '\d+\.\d+\.\d+' -AllMatches).Matches.Value | Select-Object -First 1
          if (-not $ver) {
            Write-Warning "Could not parse version from output: $out"
            $ver = "unknown"
          }

          # Save result for summary table
          $resultsDir = Join-Path $env:RUNNER_TEMP "results"
          New-Item -ItemType Directory -Force -Path $resultsDir | Out-Null
          Set-Content -Path "$resultsDir\${{ env.TRIPLET }}.txt" -Value $ver

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: version-${{ env.TRIPLET }}
          path: ${{ runner.temp }}/results/*.txt
          retention-days: 1

  summary:
    needs:
      - linux
      - linux-apt
      - linux-copr
      - linux-dnf
      - linux-snap
      - linux-zypper
      - macos
      - windows
    runs-on: ubuntu-24.04
    if: always() && github.repository == 'kubetail-org/kubetail'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/artifacts
          pattern: version-*
          merge-multiple: true

      - name: Generate summary
        run: |
          set -euo pipefail

          artifacts_dir="/tmp/artifacts"
          readarray -t files < <(find "$artifacts_dir" -type f -name '*.txt' -print | sort)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No artifacts were downloaded." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Pull out the first semver-looking token; fall back to raw content when missing.
          extract_version() {
            local file="$1"
            local content
            content="$(tr -d '\r' < "$file")"

            if [[ "$content" =~ ([0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z]+)*) ]]; then
              echo "${BASH_REMATCH[1]}"
            else
              echo "$content" | head -n 1
            fi
          }

          declare -A versions
          declare -A managers_seen
          declare -A platforms_seen

          for file in "${files[@]}"; do
            base="$(basename "$file" .txt)"
            IFS='_' read -r mgr os arch <<< "$base"

            # Skip malformed artifact names.
            if [ -z "${mgr:-}" ] || [ -z "${os:-}" ] || [ -z "${arch:-}" ]; then
              continue
            fi

            os_arch="${os}/${arch}"
            version="$(extract_version "$file")"

            versions["${mgr}|${os_arch}"]="$version"
            managers_seen["$mgr"]=1
            platforms_seen["${mgr}|${os_arch}"]=1
          done

          if [ ${#managers_seen[@]} -eq 0 ]; then
            echo "No valid artifacts were processed." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          readarray -t managers < <(printf '%s\n' "${!managers_seen[@]}" | sort)

          {
            echo "## Package Health Check Summary"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          for mgr in "${managers[@]}"; do
            readarray -t columns < <(
              printf '%s\n' "${!platforms_seen[@]}" |
                awk -F '|' -v target="$mgr" '$1 == target { print $2 }' |
                sort -u
            )

            {
              echo "### ${mgr}"

              if [ ${#columns[@]} -eq 0 ]; then
                echo "No results."
                echo ""
                continue
              fi

              header="|"
              separator="|"
              row="|"

              for col in "${columns[@]}"; do
                header+=" ${col} |"
                separator+=" --- |"
                value="${versions["${mgr}|${col}"]}"
                [ -n "${value:-}" ] || value=" "
                row+=" ${value} |"
              done

              echo "$header"
              echo "$separator"
              echo "$row"
              echo ""
            } >> "$GITHUB_STEP_SUMMARY"
          done
