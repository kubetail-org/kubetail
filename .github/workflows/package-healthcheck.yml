name: package-healthcheck

on:
  schedule:
    - cron: "23 3 * * *" # daily, UTC
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: package-healthcheck
  cancel-in-progress: true

jobs:
  linux:
    strategy:
      fail-fast: false
      matrix:
        runner:
          - ubuntu-24.04
          - ubuntu-24.04-arm
        config:
          - mgr: apt
            image: ubuntu:24.04
            setup: |
              apt-get update
              apt-get install -y software-properties-common curl jq
            install: |
              add-apt-repository -y ppa:kubetail/kubetail
              apt-get update
              apt-get install -y kubetail-cli
            version: |
              kubetail --version
          #- mgr: asdf
          #  image: debian:12
          #  setup: |
          #    apt-get update && apt-get install -y git curl
          #    git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.14.1
          #    echo "$HOME/.asdf/bin" >> $GITHUB_PATH
          #    echo "$HOME/.asdf/shims" >> $GITHUB_PATH
          #  install: |
          #    asdf plugin add kubetail https://github.com/kubetail-org/asdf-kubetail.git
          #    asdf install kubetail latest
          #  version: |
          #    kubetail --version
          - mgr: homebrew
            image: homebrew/brew:latest
            setup: skip
            install: |
              brew install kubetail
            version: |
              kubetail --version
          - mgr: dnf
            image: fedora:42
            setup: |
              dnf -y install dnf-plugins-core curl jq
              dnf config-manager addrepo --from-repofile=https://download.opensuse.org/repositories/home:/kubetail/Fedora_42/home:kubetail.repo
            install: |
              dnf -y install kubetail-cli
            version: |
              kubetail --version
          - mgr: krew
            image: bitnami/kubectl:latest
            setup: |
              apt-get update && apt-get install -y curl tar git
              set -eux
              curl -fsSLO https://github.com/kubernetes-sigs/krew/releases/latest/download/krew-linux_${ARCH}.tar.gz
              tar zxvf krew-linux_${ARCH}.tar.gz
              ./krew-linux_${ARCH} install krew
              echo "$HOME/.krew/bin" >> $GITHUB_PATH
            install: |
              PATH="$HOME/.krew/bin:$PATH" kubectl krew install kubetail
            version: |
              kubectl kubetail --version
          - mgr: nix
            image: ubuntu:24.04
            setup: |
              apt-get update && apt-get install -y curl
              curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --no-confirm --init none
            install: |
              . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
              nix-env -i -f https://github.com/kubetail-org/kubetail-nix/archive/refs/heads/main.tar.gz
            version: |
              . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
              kubetail --version
          - mgr: zypper
            image: opensuse/leap:15.6
            setup: |
              zypper -n refresh
              rpm --import https://download.opensuse.org/repositories/home:/kubetail/15.6/repodata/repomd.xml.key
              zypper -n addrepo "https://download.opensuse.org/repositories/home:/kubetail/15.6/" kubetail
              zypper -n refresh
            install: |
              zypper install -y kubetail-cli
            version: |
              kubetail --version
        include:
          - runner: ubuntu-24.04
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.runner }}
    container:
      image: ${{ matrix.config.image }}
      options: --user 0
    env:
      ARCH: ${{ matrix.arch }}
      TRIPLET: ${{ matrix.config.mgr }}_linux_${{ matrix.arch }}
    steps:
      - name: Setup
        shell: bash
        run: |
          set -euxo pipefail
          # Run matrix setup script via heredoc to avoid premature $ expansion under set -u
          if [ "${{ matrix.config.setup }}" != "skip" ]; then
            eval "${{ matrix.config.setup }}"
          fi

      - name: Install
        shell: bash
        run: |
          set -euxo pipefail
          eval "${{ matrix.config.install }}"

      - name: Check version
        shell: bash
        run: |
          set -euxo pipefail
          cli_ver="$(eval "${{ matrix.config.version }}")"

          # Save result for summary table
          mkdir -p /tmp/results
          echo "${cli_ver}" > "/tmp/results/${{ env.TRIPLET }}.txt"

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: version-${{ env.TRIPLET }}
          path: /tmp/results/*.txt
          retention-days: 1

  macos:
    strategy:
      fail-fast: false
      matrix:
        runner:
          - macos-26
          - macos-15
          - macos-15-intel
        config:
          - mgr: homebrew
            setup: skip
            install: |
              brew update
              brew install kubetail
            version: |
              kubetail --version
          - mgr: krew
            setup: |
              brew install kubectl
              curl -fsSLO https://github.com/kubernetes-sigs/krew/releases/latest/download/krew-darwin_${ARCH}.tar.gz
              tar zxvf krew-darwin_${ARCH}.tar.gz
              ./krew-darwin_${ARCH} install krew
              echo "$HOME/.krew/bin" >> $GITHUB_PATH
            install: |
              kubectl krew update
              kubectl krew install kubetail
            version: |
              kubectl kubetail --version
          - mgr: macports
            setup: |
              # Set MacPorts installer URL based on OS version
              curl -fL -o MacPorts.pkg "${MACPORTS_URL}"
              printf 'Agree\n' | sudo installer -pkg MacPorts.pkg -target /
              echo "PATH=/opt/local/bin:/opt/local/sbin:$PATH" >> "$GITHUB_ENV"
            install: |
              sudo /opt/local/bin/port -v selfupdate
              sudo /opt/local/bin/port install kubetail
            version: |
              kubetail --version
          - mgr: nix
            setup: |
              curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
            install: |
              . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
              nix-env -i -f https://github.com/kubetail-org/kubetail-nix/archive/refs/heads/main.tar.gz
            version: |
              . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
              kubetail --version
        include:
          - runner: macos-26
            os: macos-26
            arch: arm64
            macports_url: https://github.com/macports/macports-base/releases/download/v2.11.6/MacPorts-2.11.6-26-Tahoe.pkg
          - runner: macos-15
            os: macos-15
            arch: arm64
            macports_url: https://github.com/macports/macports-base/releases/download/v2.10.5/MacPorts-2.10.5-15-Sequoia.pkg
          - runner: macos-15-intel
            os: macos-15
            arch: amd64
            macports_url: https://github.com/macports/macports-base/releases/download/v2.10.5/MacPorts-2.10.5-15-Sequoia.pkg
        exclude:
          - runner: macos-15-intel
            config:
              mgr: nix
    runs-on: ${{ matrix.runner }}
    env:
      ARCH: ${{ matrix.arch }}
      TRIPLET: ${{ matrix.config.mgr }}_${{ matrix.os }}_${{ matrix.arch }}
      MACPORTS_URL: ${{ matrix.macports_url }}
    steps:
      - name: Setup
        run: |
          set -euxo pipefail
          # Run matrix setup script via heredoc to avoid premature $ expansion under set -u
          if [ "${{ matrix.config.setup }}" != "skip" ]; then
            eval "${{ matrix.config.setup }}"
          fi

      - name: Install
        run: |
          set -euxo pipefail
          eval "${{ matrix.config.install }}"

      - name: Check version
        run: |
          set -euxo pipefail
          cli_ver="$(eval "${{ matrix.config.version }}")"

          # Save result for summary table
          mkdir -p /tmp/results
          echo "${cli_ver}" > "/tmp/results/${{ env.TRIPLET }}.txt"

      - name: Upload result
        uses: actions/upload-artifact@v4
        if: ${{ matrix.config.mgr != 'nix' }}
        with:
          name: version-${{ env.TRIPLET }}
          path: /tmp/results/*.txt
          retention-days: 1

  windows:
    strategy:
      fail-fast: false
      matrix:
        runner:
          - windows-2025
          - windows-11-arm
        config:
          - mgr: winget
            install: |
              winget install -e kubetail --accept-source-agreements --accept-package-agreements
            check_ver: |
              $env:PATH = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

              # Add common winget install locations to PATH
              $wingetPaths = @(
                "$env:LOCALAPPDATA\Microsoft\WinGet\Links",
                "$env:LOCALAPPDATA\Microsoft\WinGet\Packages"
              )
              foreach ($path in $wingetPaths) {
                if (Test-Path $path) {
                  $env:PATH = "$path;" + $env:PATH
                }
              }

              kubetail.exe --version
          - mgr: chocolatey
            setup: |
              # Add chocolatey bin to PATH
              if ($env:ChocolateyInstall) {
                $chocoBin = "$($env:ChocolateyInstall)\bin"
                if ($chocoBin) {
                  $env:PATH = "$chocoBin;" + $env:PATH
                  $chocoBin | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
                }
              }
            install: |
              choco install kubetail -y --no-progress
            check_ver: |
              kubetail.exe --version
          - mgr: scoop
            setup: |
              # Install scoop if not present
              if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
                iwr -useb get.scoop.sh | iex
              }
              if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
                throw "scoop install failed"
              }

              # Add scoop shims to PATH for subsequent steps
              $scoopShims = "$env:USERPROFILE\scoop\shims"
              if (Test-Path $scoopShims) {
                $env:PATH = "$scoopShims;" + $env:PATH
                $scoopShims | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
              }

              # Add extras bucket
              try { scoop bucket add extras | Out-Null } catch { }
            install: |
              scoop install kubetail
            check_ver: |
              kubetail.exe --version
        include:
          - runner: windows-2025
            arch: amd64
          - runner: windows-11-arm
            arch: arm64
        exclude:
          - runner: windows-11-arm
            config:
              mgr: winget
    runs-on: ${{ matrix.runner }}
    env:
      TRIPLET: ${{ matrix.config.mgr }}_windows_${{ matrix.arch }}
    steps:
      - name: Setup
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'

          $setup = @'
          ${{ matrix.config.setup }}
          '@.Trim()
          if ($setup) {
            Invoke-Expression $setup
          }

      - name: Install
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'

          $install = @'
          ${{ matrix.config.install }}
          '@.Trim()
          if ($install) {
            Invoke-Expression $install
          }

      - name: Check version
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'

          $check = @'
          ${{ matrix.config.check_ver }}
          '@.Trim()
          $out = Invoke-Expression $check 2>&1
          $ver = ($out | Select-String -Pattern '\d+\.\d+\.\d+' -AllMatches).Matches.Value | Select-Object -First 1
          if (-not $ver) {
            Write-Warning "Could not parse version from output: $out"
            $ver = "unknown"
          }

          # Save result for summary table
          $resultsDir = Join-Path $env:RUNNER_TEMP "results"
          New-Item -ItemType Directory -Force -Path $resultsDir | Out-Null
          Set-Content -Path "$resultsDir\${{ env.TRIPLET }}.txt" -Value $ver

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: version-${{ env.TRIPLET }}
          path: ${{ runner.temp }}/results/*.txt
          retention-days: 1

  summary:
    needs: [linux, macos, windows]
    runs-on: ubuntu-24.04
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/artifacts
          pattern: version-*
          merge-multiple: true

      - name: Generate summary table
        run: |
          set -euo pipefail

          # Define the matrix
          managers=("apt" "asdf" "chocolatey" "dnf" "homebrew" "krew" "macports" "nix" "scoop" "winget" "zypper")
          platforms=("linux/amd64" "linux/arm64" "macos-15/amd64" "macos-15/arm64" "macos-26/arm64" "windows/amd64" "windows/arm64")

          # Function to get version from file
          get_version() {
            local mgr=$1
            local os=$2
            local arch=$3
            local file="/tmp/artifacts/${mgr}_${os}_${arch}.txt"

            if [ -f "$file" ]; then
              # Extract version number from content (e.g., "kubetail version 1.2.3" -> "1.2.3")
              local content=$(cat "$file")
              if [[ "$content" =~ ([0-9]+\.[0-9]+\.[0-9]+) ]]; then
                echo "${BASH_REMATCH[1]}"
              else
                echo "$content"
              fi
            else
              echo ""
            fi
          }

          # Start building the markdown table
          {
            echo "## Package Health Check Summary"
            echo ""
            echo "| Package Manager | linux/amd64 | linux/arm64 | macos-15/amd64 | macos-15/arm64 | macos-26/arm64 | windows/amd64 | windows/arm64 |"
            echo "|-----------------|-------------|-------------|----------------|----------------|----------------|---------------|---------------|"

            for mgr in "${managers[@]}"; do
              row="| ${mgr}"

              for platform in "${platforms[@]}"; do
                os="${platform%/*}"
                arch="${platform#*/}"
                version=$(get_version "$mgr" "$os" "$arch")

                if [ -z "$version" ]; then
                  cell=" "
                elif [ "$version" = "unknown" ]; then
                  cell="X"
                else
                  cell="$version"
                fi

                row="${row} | ${cell}"
              done

              row="${row} |"
              echo "$row"
            done
          } >> "$GITHUB_STEP_SUMMARY"
